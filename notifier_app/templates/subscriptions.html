<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Manage Subscriptions - Plex Notifier</title>
  <link rel="icon" type="image/png" href="https://github.com/jjermany/plex-notifier/raw/main/media/logo.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/darkly/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-play-circle-fill"></i> Plex Notifier
      </a>
    </div>
  </nav>

  <div class="container subscription-container mt-5 mb-5">
    <!-- Header -->
    <div class="text-center mb-4">
      <img src="https://github.com/jjermany/plex-notifier/blob/main/media/logo.png?raw=true"
           alt="Notifier Logo"
           height="64"
           class="mb-3">
      <h2 class="text-white mb-2">
        <i class="bi bi-gear-fill"></i> Manage Your Notification Preferences
      </h2>
      <p class="text-muted">Control which notifications you receive from Plex Notifier</p>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            <i class="bi bi-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-triangle{% else %}info-circle{% endif %}-fill me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if email %}
      <!-- User Info Card -->
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-person-circle"></i> Subscription Settings for
        </div>
        <div class="card-body">
          <p class="mb-0">
            <i class="bi bi-envelope-fill text-plex-orange"></i>
            <strong>{{ email }}</strong>
          </p>
        </div>
      </div>

      <form method="POST">
        <!-- Secure Token -->
        <input type="hidden" name="token" value="{{ token }}">

        <!-- Global Opt-Out Card -->
        <div class="card mb-4">
          <div class="card-header">
            <i class="bi bi-bell-slash-fill"></i> Global Notification Settings
          </div>
          <div class="card-body">
            <div class="form-check form-switch">
              <input class="form-check-input"
                     type="checkbox"
                     id="globalOptOut"
                     name="global_opt_out"
                     {% if global_opt_out %}checked{% endif %}
                     style="width: 3rem; height: 1.5rem;">
              <label class="form-check-label text-white ms-2" for="globalOptOut">
                <strong>Unsubscribe from all notifications</strong>
              </label>
            </div>
            <div class="alert alert-warning mt-3 mb-0" role="alert">
              <i class="bi bi-exclamation-triangle-fill"></i>
              <strong>Note:</strong> Checking this will disable all episode alerts for this email address.
              You will not receive any notifications until you turn this back off.
            </div>
          </div>
        </div>

        <!-- Per-Show Preferences Card -->
        <div class="card mb-4">
          <div class="card-header">
            <i class="bi bi-tv-fill"></i> Individual Show Preferences
          </div>
          <div class="card-body">
            <p class="text-white mb-3">
              Check the box next to any show you no longer wish to receive notifications for.
            </p>

            {% if inactive_count > 0 and not show_inactive %}
              <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle-fill"></i>
                <strong>{{ inactive_count }}</strong> inactive show{{ 's' if inactive_count != 1 else '' }} hidden (no notifications in 12+ months).
                <a href="{{ url_for('subscriptions', token=token, show_inactive='true') }}" class="alert-link">Show all shows</a>
              </div>
            {% elif show_inactive %}
              <div class="alert alert-warning" role="alert">
                <i class="bi bi-eye-fill"></i>
                Showing all shows, including inactive ones.
                <a href="{{ url_for('subscriptions', token=token, show_inactive='false') }}" class="alert-link">Hide inactive shows</a>
              </div>
            {% endif %}

            {% if shows or search_query %}
              <!-- Search Box -->
              <div class="mb-3" id="showSearchContainer">
                <div class="input-group">
                  <span class="input-group-text bg-dark border-secondary">
                    <i class="bi bi-search"></i>
                  </span>
                  <input type="text"
                         class="form-control"
                         id="showSearch"
                         data-token="{{ token }}"
                         data-show-inactive="{{ 'true' if show_inactive else 'false' }}"
                         value="{{ search_query or '' }}"
                         placeholder="Search all shows..."
                         aria-label="Search shows">
                  {% if search_query %}
                  <a href="{{ url_for('subscriptions', token=token, show_inactive='true' if show_inactive else 'false') }}"
                     class="btn btn-outline-secondary" id="clearSearch">
                    <i class="bi bi-x-lg"></i>
                  </a>
                  {% endif %}
                  <button class="btn btn-primary" type="button" id="searchButton">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                {% if search_query %}
                <small class="text-muted">
                  <i class="bi bi-funnel-fill"></i> Filtering by: <strong>{{ search_query }}</strong> ({{ shows|length }} result{{ 's' if shows|length != 1 else '' }})
                </small>
                {% else %}
                <small class="text-muted">
                  <i class="bi bi-info-circle"></i> Search across all subscribed shows
                </small>
                {% endif %}
              </div>
              {% endif %}
              {% if shows %}
              <div class="show-checkbox-list">
                {% for show in shows %}
                  <div class="form-check mb-2">
                    <input class="form-check-input"
                           type="checkbox"
                           id="show_{{ loop.index }}"
                           name="show_optouts"
                           value="{{ show.key }}"
                           {% if show.key in opted_out_shows %}checked{% endif %}>
                    <label class="form-check-label text-white" for="show_{{ loop.index }}">
                      <i class="bi bi-film"></i> {{ show.title }}
                    </label>
                  </div>
                {% endfor %}
              </div>

              <!-- Pagination -->
              {% if total_pages > 1 %}
              <nav aria-label="Shows pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                  <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a class="page-link"
                       href="{{ url_for('subscriptions', token=token, page=page-1, show_inactive='true' if show_inactive else 'false', search=search_query) }}"
                       aria-label="Previous">
                      <i class="bi bi-chevron-left"></i> Previous
                    </a>
                  </li>

                  {% if total_pages <= 7 %}
                    {% for p in range(1, total_pages + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                      <a class="page-link"
                         href="{{ url_for('subscriptions', token=token, page=p, show_inactive='true' if show_inactive else 'false', search=search_query) }}">
                        {{ p }}
                      </a>
                    </li>
                    {% endfor %}
                  {% else %}
                    <!-- Show first page -->
                    <li class="page-item {% if page == 1 %}active{% endif %}">
                      <a class="page-link" href="{{ url_for('subscriptions', token=token, page=1, show_inactive='true' if show_inactive else 'false', search=search_query) }}">1</a>
                    </li>

                    {% if page > 3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}

                    <!-- Show pages around current -->
                    {% for p in range([page-1, 2]|max, [page+1, total_pages-1]|min + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                      <a class="page-link" href="{{ url_for('subscriptions', token=token, page=p, show_inactive='true' if show_inactive else 'false', search=search_query) }}">{{ p }}</a>
                    </li>
                    {% endfor %}

                    {% if page < total_pages - 2 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}

                    <!-- Show last page -->
                    <li class="page-item {% if page == total_pages %}active{% endif %}">
                      <a class="page-link" href="{{ url_for('subscriptions', token=token, page=total_pages, show_inactive='true' if show_inactive else 'false', search=search_query) }}">{{ total_pages }}</a>
                    </li>
                  {% endif %}

                  <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a class="page-link"
                       href="{{ url_for('subscriptions', token=token, page=page+1, show_inactive='true' if show_inactive else 'false', search=search_query) }}"
                       aria-label="Next">
                      Next <i class="bi bi-chevron-right"></i>
                    </a>
                  </li>
                </ul>
              </nav>
              {% endif %}
            {% else %}
              <div class="text-center py-4">
                <i class="bi bi-{% if search_query %}search{% else %}inbox{% endif %}" style="font-size: 3rem; color: var(--plex-orange);"></i>
                {% if search_query %}
                <p class="text-muted mt-3 mb-0">No shows found matching "{{ search_query }}".</p>
                <p class="text-muted">
                  <a href="{{ url_for('subscriptions', token=token, show_inactive='true' if show_inactive else 'false') }}" class="alert-link">Clear search</a> to see all shows.
                </p>
                {% else %}
                <p class="text-muted mt-3 mb-0">No shows found in your notification history.</p>
                <p class="text-muted">You'll see shows here once you start receiving notifications.</p>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Save Button -->
        <div class="card">
          <div class="card-body text-center">
            <button type="submit" class="btn btn-warning btn-lg hover-lift px-5">
              <i class="bi bi-check-circle-fill"></i> Save My Notification Preferences
            </button>
            <p class="text-muted mt-3 mb-0">
              <i class="bi bi-info-circle"></i> Your preferences are saved securely and can be changed at any time.
            </p>
          </div>
        </div>
      </form>

      <!-- Help Section -->
      <div class="card mt-4 bg-transparent border-secondary">
        <div class="card-body">
          <h6 class="text-plex-orange mb-3">
            <i class="bi bi-question-circle-fill"></i> Need Help?
          </h6>
          <ul class="text-light mb-0">
            <li class="mb-2">
              <strong>Global Opt-Out:</strong> Turns off all notifications completely
            </li>
            <li class="mb-2">
              <strong>Individual Show Opt-Outs:</strong> Turn off notifications for specific shows only
            </li>
            <li class="mb-2">
              <strong>Re-subscribe:</strong> Simply uncheck the boxes and save to start receiving notifications again
            </li>
          </ul>
        </div>
      </div>

    {% else %}
      <!-- Error State -->
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 4rem;"></i>
          <h4 class="text-white mt-4 mb-3">Invalid or Missing Token</h4>
          <p class="text-muted mb-0">
            No email address provided or the token is invalid.
            Please use the link from your notification email to access this page.
          </p>
        </div>
      </div>
    {% endif %}

    <!-- Footer -->
    <div class="text-center mt-5 text-muted">
      <p class="mb-1">
        <i class="bi bi-shield-check"></i> Your privacy is important to us. Your preferences are stored securely.
      </p>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Custom JavaScript -->
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
